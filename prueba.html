<pre id="pedidos"></pre>
<pre id="CONTADOR"></pre>
<script>
(function(){
 document.addEventListener('DOMContentLoaded', function() {
    iniciarApp();
  });
    
  function iniciarApp() {
    desgloza();
    Cj();
    DatosCompletos();
  }

async function pedidoss() {
    try {
        const url = 'https://serviacrilico.com/admin/api/allpedidos2';
        const resultado = await fetch(url);
        const pedidos = await resultado.json();
        return pedidos;

    } catch (e) {
        console.log(e);
    }
}



async function filtradoPendientes() {
    const verificar = await pedidoss(); 
    return verificar.filter(pedido => pedido.estado_pedido === "pendiente");
}


function extraerDimensiones(nombreProducto) {
    const regexDimensiones = /(\d+)(?:X|x)(\d+)\s*(?:X|x)?\s*(\d+)?\s*(CM|cm)?/;
    const regexTipo = /\b(K\/K|B\/B|T\/T|B\/k)\b/i;
    const regexTest = /\bTEST (\d+)\b/i;
    const regexFlauta = /\bFLAUTA (C|B)\b/i; 

    // Extraer dimensiones
    const [_, largo, ancho, alto = 'N/A'] = regexDimensiones.exec(nombreProducto) || [];

    // Extraer tipo, test y flauta
    const tipo = (regexTipo.exec(nombreProducto) || [])[1] || 'N/A';
    const test = (regexTest.exec(nombreProducto) || [])[1] || 'N/A';
    let flauta = (regexFlauta.exec(nombreProducto) || [])[1] || 'C';

    // Sobrescribir flauta como "C" si el producto contiene "CJ"
    // if (/CJ/i.test(nombreProducto)) {
    //     flauta = 'C';
    // }

    return {
        largo: largo || 'N/A',
        ancho: ancho || 'N/A',
        alto: alto,
        tipo,
        test,
        flauta
    };
}






// Función para desglosar los pedidos pendientes
async function desgloza() {
    let peddidoDesglosado = [];
    const pedidosPendientes = await filtradoPendientes(); 
    pedidosPendientes.forEach(pedido => {
        const dimensiones = extraerDimensiones(pedido.nombre_producto);
        const pedidoDesglosado = {
            id: pedido.id,
            nombre_cliente: pedido.nombre_cliente,
            numero_pedido: pedido.numero_pedido,
            fecha_pedido: pedido.fecha_pedido,
            plazo_entrega: pedido.plazo_entrega,
            nombre_producto: pedido.nombre_producto,
            cantidad: pedido.cantidad,
            subtotal: pedido.subtotal,
            total: pedido.total,
            largo: dimensiones.largo,
            ancho: dimensiones.ancho,
            alto: dimensiones.alto,
            tipo: dimensiones.tipo, 
            test: dimensiones.test, 
            flauta: dimensiones.flauta, 
            
        };

        peddidoDesglosado.push(pedidoDesglosado);

        
    });
  

   return peddidoDesglosado;
    
}

async function Cj(){
    const verificar = await desgloza(); 
    const productosCJ = []; // Array para los productos CJ
    const productosPL = []; // Array para los productos PL

    // Separa los productos según el tipo (CJ o PL) y sus medidas
    verificar.forEach(pedido => {
        if (pedido.alto !== "N/A") {  // Si el alto es diferente de "N/A", es un producto CJ
            productosCJ.push(pedido);
        } else {  // Si el alto es "N/A", es un producto PL
            productosPL.push(pedido);
        }
    });

    const CJ= [];
    const CJcalculados = productosCJ.map(producto => { 
        const { id, nombre_cliente, numero_pedido, fecha_pedido, plazo_entrega, nombre_producto, cantidad, subtotal, total, tipo, test, flauta } = producto;
        let largoCJ = parseFloat(producto.largo);
        let anchoCJ = parseFloat(producto.ancho);
        let altoCJ = parseFloat(producto.alto);

        let largo = (2*parseFloat(altoCJ))+parseFloat(largoCJ)+8;
        // console.log(LargoCalculado);
        let ancho = (2*parseFloat(altoCJ))+parseFloat(anchoCJ)+10+4
        // console.log(AnchoCalculado);
        // agregar todo al array CJ
        CJ.push({
            id,
            nombre_cliente,
            numero_pedido,
            fecha_pedido,
            plazo_entrega,
            nombre_producto,
            cantidad,
            subtotal,
            total,
            largo,
            ancho,
            tipo,
            test,
            flauta
        });
    });

   const DatosFormateador =[...CJ,...productosPL];

       
    return DatosFormateador;
}

async function DatosCompletos() {
    const formatear = await Cj();  
    const AnchosBobinas = [1880]; // Bobinas disponibles
    const refile = 30; 

    formatear.forEach(pedido => {
        delete pedido.alto;
        // convertimos a flotante
        pedido.largo = parseFloat(pedido.largo);
        // convertimos a flotante
        pedido.ancho = parseFloat(pedido.ancho);

        pedido.cantidad = parseInt(pedido.cantidad);

    });



        console.log(formatear); // Mostrar en consola
}





})();

</script>