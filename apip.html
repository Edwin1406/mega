<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Procesos</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      margin-top: 20px;
      font-size: 24px;
      color: #222;
    }

    .filter-container {
      margin: 20px 0;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    label {
      font-size: 14px;
    }

    input, select, button {
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
    }

    button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #0056b3;
    }

    .result-container {
      margin-top: 20px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      width: 100%;
      max-width: 800px;
    }

    .total-productos, .total-general, .total-pedidos-urgentes {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      width: 200px;
    }

    .total-productos img, .total-general img, .total-pedidos-urgentes img {
      width: 50px;
      height: auto;
      margin-bottom: 10px;
    }

    .total-productos h2, .total-general h2, .total-pedidos-urgentes h2 {
      margin: 0;
      font-size: 18px;
      color: #555;
    }

    .total-productos p, .total-general p, .total-pedidos-urgentes p {
      margin: 5px 0 0;
      font-size: 32px;
      font-weight: bold;
      color: #007bff;
      cursor: pointer;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
      background-color: #fff;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      border-radius: 10px;
      width: 80%;
      max-width: 600px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      margin: 0;
    }

    .modal-close {
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }

    .modal-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .modal-table th, .modal-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    .modal-table th {
      background-color: #007bff;
      color: white;
    }
  </style>
</head>
<body>
  <h1>Dashboard de procesos</h1>
  <div class="filter-container">
    <label for="fechaInicio">Fecha de inicio:</label>
    <input type="date" id="fechaInicio">
    
    <label for="fechaFin">Fecha de fin:</label>
    <input type="date" id="fechaFin">

    <label for="marca">Marca:</label>
    <select id="marca">
      <option value="">Todas</option>
      <option value="mondi">Mondi</option>
      <option value="europcell">Europcell</option>
    </select>

    <label for="trader">Trader:</label>
    <select id="trader">
      <option value="">Todos</option>
    </select>

    <label for="producto">Producto:</label>
    <select id="producto">
      <option value="">Todos</option>
    </select>

    <label for="ancho">Ancho:</label>
    <select id="ancho">
      <option value="">Todos</option>
    </select>

    <label for="gms">GMS:</label>
    <select id="gms">
      <option value="">Todos</option>
    </select>

    <button onclick="filterData()">Filtrar</button>
  </div>

  <div id="results" class="result-container">
    <div class="total-productos">
      <img src="https://img.icons8.com/color/96/box--v1.png" alt="Icono de productos">
      <h2>Total Productos</h2>
      <p id="totalProductos">0</p>
    </div>
    <div class="total-general">
      <img src="https://img.icons8.com/color/96/accounting.png" alt="Icono de total general">
      <h2>Total General</h2>
      <p id="totalGeneral">0.00 $</p>
    </div>
    <div class="total-pedidos-urgentes" onclick="showUrgentOrders()">
      <img src="https://img.icons8.com/external-flatart-icons-lineal-color-flatarticons/64/000000/external-delivery-logistics-flatart-icons-lineal-color-flatarticons.png" alt="Icono de pedidos urgentes">
      <h2>Total Pedido Urgente</h2>
      <p id="totalPedidosUrgentes">0</p>
    </div>
  </div>

  <!-- Modal -->
  <div id="urgentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Pedidos Urgentes</h2>
        <span class="modal-close" onclick="closeModal()">&times;</span>
      </div>
      <table class="modal-table" id="urgentTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Producto</th>
            <th>Marca</th>
            <th>Cantidad</th>
            <th>Observaciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', loadFilters);

    let filteredData = [];

    function loadFilters() {
      axios.get('https://megawebsistem.com/admin/api/apiestadisticas')
        .then(response => {
          const data = response.data;

          populateFilter(data, 'trader', 'trader');
          populateFilter(data, 'producto', 'producto');
          populateFilter(data, 'ancho', 'ancho');
          populateFilter(data, 'gms', 'gms');
        })
        .catch(error => {
          console.error('Error al cargar los filtros:', error);
        });
    }

    function populateFilter(data, elementId, key) {
      const uniqueValues = [...new Set(data.map(item => item[key]))];
      const selectElement = document.getElementById(elementId);

      uniqueValues.forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        selectElement.appendChild(option);
      });
    }

    function filterData() {
      const fechaInicio = document.getElementById('fechaInicio').value;
      const fechaFin = document.getElementById('fechaFin').value;
      const marca = document.getElementById('marca').value;
      const trader = document.getElementById('trader').value;
      const producto = document.getElementById('producto').value;
      const ancho = document.getElementById('ancho').value;
      const gms = document.getElementById('gms').value;

      if (!fechaInicio || !fechaFin) {
        alert('Por favor, selecciona ambas fechas.');
        return;
      }

      axios.get('https://megawebsistem.com/admin/api/apiestadisticas')
        .then(response => {
          const data = response.data;
          filteredData = data.filter(item => {
            const fechaSolicitud = new Date(item.fecha_solicitud);
            const matchesFecha = fechaSolicitud >= new Date(fechaInicio) && fechaSolicitud <= new Date(fechaFin);
            const matchesMarca = !marca || item.marca === marca;
            const matchesTrader = !trader || item.trader === trader;
            const matchesProducto = !producto || item.producto === producto;
            const matchesAncho = !ancho || item.ancho === ancho;
            const matchesGms = !gms || item.gms === gms;
            return matchesFecha && matchesMarca && matchesTrader && matchesProducto && matchesAncho && matchesGms;
          });

          updateTotals(filteredData);
          updateTotalPedidosUrgentes(filteredData);
        })
        .catch(error => {
          console.error('Error al consumir la API:', error);
        });
    }

    function updateTotals(data) {
      const totalProductos = data.length;
      const totalGeneral = data.reduce((sum, item) => sum + parseFloat(item.total_item || 0), 0);

      document.getElementById('totalProductos').textContent = totalProductos;
      document.getElementById('totalGeneral').textContent = totalGeneral.toFixed(2) + ' $';
    }

    function updateTotalPedidosUrgentes(data) {
      const totalUrgentes = data.filter(item => item.observaciones && item.observaciones.toLowerCase().includes("urgente")).length;
      document.getElementById('totalPedidosUrgentes').textContent = totalUrgentes;
    }

    function showUrgentOrders() {
      const urgentData = filteredData.filter(item => item.observaciones && item.observaciones.toLowerCase().includes("urgente"));

      const tableBody = document.querySelector('#urgentTable tbody');
      tableBody.innerHTML = '';

      urgentData.forEach(order => {
        const row = document.createElement('tr');

        row.innerHTML = `
          <td>${order.id}</td>
          <td>${order.producto}</td>
          <td>${order.marca}</td>
          <td>${order.cantidad}</td>
          <td>${order.observaciones || 'N/A'}</td>
        `;

        tableBody.appendChild(row);
      });

      document.getElementById('urgentModal').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('urgentModal').style.display = 'none';
    }
  </script>
</body>
</html>
