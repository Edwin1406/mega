<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Tabla de Desperdicio</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f6f8;
      padding: 20px;
    }

    h2 {
      text-align: center;
      color: #333;
    }

    .filtros {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin-bottom: 20px;
    }

    .filtros label {
      font-weight: bold;
      margin-right: 5px;
    }

    .filtros select,
    .filtros input[type="date"] {
      padding: 5px;
      border-radius: 5px;
      border: 1px solid #d85a5a;
    }

    table.dataTable thead {
      background-color: #5388bd;
      color: white;
    }

    table.dataTable tbody tr {
      background-color: #fff;
    }

    table.dataTable tbody tr:hover {
      background-color: #ecf0f1;
    }

    table.dataTable tfoot th {
      font-weight: bold;
      background-color: #9b5050;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button {
      padding: 0.5em 1em;
      margin-left: 4px;
      border-radius: 5px;
      border: 1px solid #ccc;
      background: #f1f1f1;
      color: #333;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
      background: #358ac4;
      color: white !important;
    }
  </style>
</head>
<body>

  <h2>Desperdicio de Papel</h2>

  <div class="filtros">
    <label for="filtroMaquina">Filtrar por tipo de máquina:</label>
    <select id="filtroMaquina"><option value="">Todos</option></select>

    <label for="filtroClasificacion">Filtrar por tipo de clasificación:</label>
    <select id="filtroClasificacion"><option value="">Todos</option></select>

    <label for="filtroFecha">Filtrar por fecha:</label>
    <input type="date" id="filtroFecha">
  </div>

  <table id="tablaDesperdicio" class="display" style="width:100%">
    <thead>
      <tr>
        <th rowspan="2">Tipo de máquina</th>
        <th rowspan="2">Tipo de clasificación</th>
        <th colspan="9" style="background-color:#9f5fa5 ;text-align: center">CONTROLABLE</th>
        <th colspan="8" style="background-color:#4988a8  ;text-align: center;">NO CONTROLABLE</th>
        <th rowspan="2">Fecha</th>
      </tr>
      <tr>
        <th>Single Face</th>
        <th>Empalme</th>
        <th>Recub</th>
        <th>Mecánico</th>
        <th>Gallet</th>
        <th>Húmedo</th>
        <th>Combinado</th>
        <th>Despe</th>
        <th>Errom</th>
        <th>Deshoje</th>
        <th>Cambio de pedido</th>
        <th>Filos rotos</th>
        <th>Otros</th>
        <th>Pedidos cortos</th>
        <th>Difer ancho</th>
        <th>Cambio de gramaje</th>
        <th>Extra trim</th>
      </tr>
    </thead>
    <tfoot>
      <tr>
        <th colspan="2">Totales:</th>
        <th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th>
        <th></th><th></th><th></th><th></th><th></th><th></th><th></th>
        <th></th>
      </tr>
    </tfoot>
    <tbody></tbody>
  </table>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
  const columnas = [
    { title: "Tipo de máquina", data: "tipo_maquina" },
    { title: "Tipo de clasificación", data: "tipo_clasificacion" },
    { title: "Single Face", data: "SINGLEFACE" },
    { title: "Empalme", data: "EMPALME" },
    { title: "Recub", data: "RECUB" },
    { title: "Mecánico", data: "MECANICO" },
    { title: "Gallet", data: "GALLET" },
    { title: "Húmedo", data: "HUMEDO" },
    { title: "Combinado", data: "COMBADO" },
    { title: "Despe", data: "DESPE" },
    { title: "Errom", data: "ERROM" },
    { title: "Deshoje", data: "DESHOJE" },
    { title: "Cambio de pedido", data: "CAMBIO_PEDIDO" },
    { title: "Filos rotos", data: "FILOS_ROTOS" },
    { title: "Otros", data: "OTROS" },
    { title: "Pedidos cortos", data: "PEDIDOS_CORTOS" },
    { title: "Difer ancho", data: "DIFER_ANCHO" },
    { title: "Cambio de gramaje", data: "CAMBIO_GRAMAJE" },
    { title: "Extra trim", data: "EXTRA_TRIM" },
    { title: "Fecha", data: "created_at" }
  ];

  const columnasControlable = ["SINGLEFACE", "EMPALME", "RECUB", "MECANICO", "GALLET", "HUMEDO", "COMBADO", "DESPE", "ERROM"];
  const columnasNoControlable = ["DESHOJE","CAMBIO_PEDIDO", "FILOS_ROTOS", "OTROS", "PEDIDOS_CORTOS", "DIFER_ANCHO", "CAMBIO_GRAMAJE", "EXTRA_TRIM"];

  $(document).ready(function () {
    let tabla;
    fetch('https://megawebsistem.com/admin/api/apidesperdiciopapel')
      .then(res => res.json())
      .then(dataOriginal => {
        const aplicarFiltroYMostrar = () => {
          const filtroMaquina = $('#filtroMaquina').val();
          const filtroClasificacion = $('#filtroClasificacion').val();
          const filtroFecha = $('#filtroFecha').val();

          let datosFiltrados = dataOriginal.filter(registro => {
            const clasificaciones = registro.tipo_clasificacion.split(',').map(x => x.trim());
            return (!filtroMaquina || registro.tipo_maquina === filtroMaquina)
              && (!filtroClasificacion || clasificaciones.includes(filtroClasificacion))
              && (!filtroFecha || registro.created_at.includes(filtroFecha));
          });

         datosFiltrados = datosFiltrados.map(reg => {
  const copia = { ...reg };
  const clasificaciones = reg.tipo_clasificacion.split(',').map(x => x.trim());

  if (filtroClasificacion === "CONTROLABLE") {
    // Si no tiene exactamente CONTROLABLE, anula columnas NO CONTROLABLE
    if (!clasificaciones.includes("CONTROLABLE")) {
      columnasControlable.forEach(col => copia[col] = "0.00");
    }
    // Siempre anula las no controlables si estoy filtrando controlables
    columnasNoControlable.forEach(col => copia[col] = "0.00");
  }

  if (filtroClasificacion === "NO CONTROLABLE") {
    if (!clasificaciones.includes("NO CONTROLABLE")) {
      columnasNoControlable.forEach(col => copia[col] = "0.00");
    }
    // Siempre anula las controlables si estoy filtrando no controlables
    columnasControlable.forEach(col => copia[col] = "0.00");
  }

  return copia;
});


          tabla.clear().rows.add(datosFiltrados).draw();
        };

        tabla = $('#tablaDesperdicio').DataTable({
          data: [],
          columns: columnas,
          footerCallback: function (row, data, start, end, display) {
            const api = this.api();
            for (let i = 2; i < columnas.length - 1; i++) {
              const total = api.column(i, { search: 'applied' }).data().reduce((a, b) => {
                return parseFloat(a) + parseFloat(b);
              }, 0);
              $(api.column(i).footer()).html(total.toFixed(2));
            }
          }
        });

        const tiposMaquina = [...new Set(dataOriginal.map(e => e.tipo_maquina.trim()))];
        tiposMaquina.forEach(tipo => {
          $('#filtroMaquina').append(`<option value="${tipo}">${tipo}</option>`);
        });

        const tiposClasificacion = [...new Set(dataOriginal.flatMap(e => e.tipo_clasificacion.split(',').map(x => x.trim())))];
        tiposClasificacion.forEach(tipo => {
          $('#filtroClasificacion').append(`<option value="${tipo}">${tipo}</option>`);
        });

        $('#filtroMaquina').on('change', aplicarFiltroYMostrar);
        $('#filtroClasificacion').on('change', aplicarFiltroYMostrar);
        $('#filtroFecha').on('change', aplicarFiltroYMostrar);

        aplicarFiltroYMostrar(); // inicial
      });
  });
</script>

</body>
</html>



<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div style="display: flex; justify-content: center; gap: 50px; margin-top: 40px;">
  <div>
    <h3 style="text-align:center">Controlables</h3>
    <canvas id="graficoControlables" width="300" height="300"></canvas>
  </div>
  <div>
    <h3 style="text-align:center">No Controlables</h3>
    <canvas id="graficoNoControlables" width="300" height="300"></canvas>
  </div>
</div>
<script>
  const columnasGraficoControl = ["SINGLEFACE", "EMPALME", "RECUB", "MECANICO", "GALLET", "HUMEDO", "COMBADO", "DESPE", "ERROM", "DESHOJE"];
  const columnasGraficoNoControl = ["CAMBIO_PEDIDO", "FILOS_ROTOS", "OTROS", "PEDIDOS_CORTOS", "DIFER_ANCHO", "CAMBIO_GRAMAJE", "EXTRA_TRIM"];

  // Función para generar los gráficos
  function generarGraficosPastel(datos) {
    const sumarColumnas = (cols, data) => cols.map(col => 
      data.reduce((acc, fila) => acc + parseFloat(fila[col] || 0), 0)
    );

    const datosCtrl = sumarColumnas(columnasGraficoControl, datos);
    const datosNoCtrl = sumarColumnas(columnasGraficoNoControl, datos);

    const colores = [
      '#7cb342', '#f44336', '#2196f3', '#ff9800',
      '#9c27b0', '#00acc1', '#cddc39', '#795548', '#e91e63', '#607d8b'
    ];

    if (window.graficoCtrl) window.graficoCtrl.destroy();
    if (window.graficoNoCtrl) window.graficoNoCtrl.destroy();

    window.graficoCtrl = new Chart(document.getElementById('graficoControlables'), {
      type: 'pie',
      data: {
        labels: columnasGraficoControl,
        datasets: [{
          data: datosCtrl,
          backgroundColor: colores
        }]
      },
      options: {
        responsive: true
      }
    });

    window.graficoNoCtrl = new Chart(document.getElementById('graficoNoControlables'), {
      type: 'pie',
      data: {
        labels: columnasGraficoNoControl,
        datasets: [{
          data: datosNoCtrl,
          backgroundColor: colores
        }]
      },
      options: {
        responsive: true
      }
    });
  }

  // Variable global para los datos originales
  let datosOriginalGraficos = [];

  // Cargar datos y mostrar gráficos por primera vez
  fetch('https://megawebsistem.com/admin/api/apidesperdiciopapel')
    .then(res => res.json())
    .then(data => {
      datosOriginalGraficos = data;
      generarGraficosPastel(datosOriginalGraficos);
    });

  // Actualizar gráficos al cambiar filtros
  $('#filtroMaquina, #filtroClasificacion, #filtroFecha').on('change', function () {
    const filtroMaquina = $('#filtroMaquina').val();
    const filtroClasificacion = $('#filtroClasificacion').val();
    const filtroFecha = $('#filtroFecha').val();

    const datosFiltradosGraficos = datosOriginalGraficos.filter(registro => {
      const clasificaciones = registro.tipo_clasificacion.split(',').map(x => x.trim());
      return (!filtroMaquina || registro.tipo_maquina === filtroMaquina)
        && (!filtroClasificacion || clasificaciones.includes(filtroClasificacion))
        && (!filtroFecha || registro.created_at.includes(filtroFecha));
    });

    generarGraficosPastel(datosFiltradosGraficos);
  });
</script>
