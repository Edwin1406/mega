<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Tabla de Desperdicio</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    tfoot input {
      width: 100%;
      box-sizing: border-box;
    }
    .filtros {
      margin-bottom: 20px;
    }
    .filtros label {
      margin-right: 10px;
    }
    .filtros select, .filtros input {
      margin-right: 20px;
    }
  </style>
</head>
<body>

  <h2>Desperdicio de Papel</h2>

  <div class="filtros">
    <label for="filtroMaquina">Filtrar por tipo de máquina:</label>
    <select id="filtroMaquina"><option value="">Todos</option></select>

    <label for="filtroClasificacion">Filtrar por tipo de clasificación:</label>
    <select id="filtroClasificacion"><option value="">Todos</option></select>

    <label for="filtroFecha">Filtrar por fecha:</label>
    <input type="date" id="filtroFecha">
  </div>

  <table id="tablaDesperdicio" class="display" style="width:100%">
    <thead><tr></tr></thead>
    <tfoot><tr></tr></tfoot>
    <tbody></tbody>
  </table>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <script>
    const columnas = [
      { title: "Tipo de máquina", data: "tipo_maquina" },
      { title: "Tipo de clasificación", data: "tipo_clasificacion" },
      { title: "Single Face", data: "SINGLEFACE" },
      { title: "Empalme", data: "EMPALME" },
      { title: "Recub", data: "RECUB" },
      { title: "Mecánico", data: "MECANICO" },
      { title: "Gallet", data: "GALLET" },
      { title: "Húmedo", data: "HUMEDO" },
      { title: "Combinado", data: "COMBADO" },
      { title: "Despe", data: "DESPE" },
      { title: "Errom", data: "ERROM" },
      { title: "Deshoje", data: "DESHOJE" },
      { title: "Cambio de pedido", data: "CAMBIO_PEDIDO" },
      { title: "Filos rotos", data: "FILOS_ROTOS" },
      { title: "Otros", data: "OTROS" },
      { title: "Pedidos cortos", data: "PEDIDOS_CORTOS" },
      { title: "Difer ancho", data: "DIFER_ANCHO" },
      { title: "Cambio de gramaje", data: "CAMBIO_GRAMAJE" },
      { title: "Extra trim", data: "EXTRA_TRIM" },
      { title: "Fecha", data: "created_at" }
    ];

    $(document).ready(function () {
      fetch('https://megawebsistem.com/admin/api/apidesperdiciopapel')
        .then(res => res.json())
        .then(data => {
          // Crear encabezado y pie de tabla
          columnas.forEach(col => {
            $('#tablaDesperdicio thead tr').append(`<th>${col.title}</th>`);
            $('#tablaDesperdicio tfoot tr').append(`<th></th>`);
          });

          const tabla = $('#tablaDesperdicio').DataTable({
            data: data,
            columns: columnas,
            footerCallback: function (row, data, start, end, display) {
              const api = this.api();
              for (let i = 2; i < columnas.length - 1; i++) {
                const total = api.column(i, { search: 'applied' }).data().reduce((a, b) => {
                  return parseFloat(a) + parseFloat(b);
                }, 0);
                $(api.column(i).footer()).html(total.toFixed(2));
              }
            }
          });

          // Filtros dinámicos
          const tiposMaquina = [...new Set(data.map(e => e.tipo_maquina.trim()))];
          tiposMaquina.forEach(tipo => {
            $('#filtroMaquina').append(`<option value="${tipo}">${tipo}</option>`);
          });

          const tiposClasificacion = [...new Set(data.map(e => e.tipo_clasificacion.trim()))];
          tiposClasificacion.forEach(tipo => {
            $('#filtroClasificacion').append(`<option value="${tipo}">${tipo}</option>`);
          });

          // Aplicar filtros
          $('#filtroMaquina').on('change', function () {
            tabla.column(0).search(this.value).draw();
          });

          $('#filtroClasificacion').on('change', function () {
            tabla.column(1).search(this.value).draw();
          });

          $('#filtroFecha').on('change', function () {
            tabla.column(19).search(this.value).draw();
          });
        });
    });
  </script>
</body>
</html>
