<style>
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
    }
    th {
        background-color: #f4f4f4;
    }
    .sobrante-optimo {
        background-color: #d4edda;
        color: #155724;
    }
    .espera {
        background-color: #f8d7da;
        color: #721c24;
    }
</style>

<table>
    <thead>
        <tr>
            <th>Bobina</th>
            <th>Pedidos</th>
            <th>Suma (Anchos)</th>
            <th>Sobrante</th>
        </tr>
    </thead>
    <tbody>
        <!-- Aquí se agregarán los resultados -->
    </tbody>
</table>

<script>
document.addEventListener('DOMContentLoaded', async function() {
    try {
        const pedidos = await obtenerPedidosFiltrados();
        const pedidosPorTipo = await separarPedidosPorTipo(pedidos);
        const resultados = await procesarPedidos(pedidosPorTipo["175-C"]);
        mostrarResultadosEnTabla(resultados);
    } catch (error) {
        console.error("Error al inicializar la aplicación:", error);
    }
});

async function obtenerPedidosFiltrados() {
    const url = 'https://serviacrilico.com/admin/api/allpedidos2';
    const response = await fetch(url);
    const pedidos = await response.json();
    return pedidos.filter(pedido => pedido.estado_pedido === "pendiente");
}

function extraerDimensiones(nombreProducto) {
    const regexDimensiones = /(\d+)\s*[Xx]\s*(\d+)\s*[Xx]?\s*(\d+)?\s*(CM|cm)?/;
    const regexTipo = /\b(K\/K|B\/B|T\/T|B\/k)\b/i;
    const regexTest = /\b(?:TEST|T)?\s?(\d{3})\b(?!.*\d{3})/i;
    const regexFlauta = /\bFLAUTA (C|B)\b/i;

    const [_, largo, ancho, alto = 'N/A'] = regexDimensiones.exec(nombreProducto) || [];
    const tipo = (regexTipo.exec(nombreProducto) || [])[1] || 'N/A';
    const test = (regexTest.exec(nombreProducto) || [])[1] || 'N/A';
    const flauta = (regexFlauta.exec(nombreProducto) || [])[1] || 'C';

    return { largo, ancho, alto, tipo, test, flauta };
}

async function procesarPedidos(pedidos) {
    const bobinas = [1880, 1700, 1500, 1300, 1100, 900, 700, 500, 300];
    const refile = 30;
    let pedidosAnchos = pedidos.map(pedido => ({
        ancho: parseFloat(pedido.ancho),
        id: pedido.id,
        cantidad: parseInt(pedido.cantidad),
        pedido: pedido
    }));

    const resultados = [];
    while (pedidosAnchos.length > 0) {
        let mejorCombinacion = encontrarMejorCombinacion(pedidosAnchos, bobinas, refile);
        if (mejorCombinacion) {
            resultados.push(mejorCombinacion);
            pedidosAnchos = pedidosAnchos.filter(p => !mejorCombinacion.pedidos.includes(p));
        } else {
            break; // No se encontró más combinaciones posibles
        }
    }
    return resultados;
}

function encontrarMejorCombinacion(pedidos, bobinas, refile) {
    let mejorCombinacion = null;
    pedidos.sort((a, b) => b.ancho - a.ancho);
    for (let bobina of bobinas) {
        const bobinaDisponible = bobina - refile;
        for (let i = 0; i < pedidos.length; i++) {
            for (let j = i + 1; j < pedidos.length; j++) {
                const suma = pedidos[i].ancho + pedidos[j].ancho;
                if (suma <= bobinaDisponible) {
                    const sobrante = bobinaDisponible - suma;
                    if (!mejorCombinacion || sobrante < mejorCombinacion.sobrante) {
                        mejorCombinacion = {
                            bobina,
                            pedidos: [pedidos[i], pedidos[j]],
                            suma,
                            sobrante
                        };
                    }
                }
            }
        }
    }
    return mejorCombinacion;
}

function mostrarResultadosEnTabla(resultados) {
    const tbody = document.querySelector('table tbody');
    resultados.forEach(resultado => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${resultado.bobina}</td>
            <td>${resultado.pedidos.map(p => `${p.pedido.nombre_producto} (ID: ${p.id})`).join(', ')}</td>
            <td>${resultado.suma}</td>
            <td>${resultado.sobrante}</td>
        `;
        tbody.appendChild(tr);
    });
}

async function separarPedidosPorTipo(pedidos) {
    const pedidosCj = pedidos.map(p => ({
        ...p,
        ...extraerDimensiones(p.nombre_producto)
    }));

    const pedidosPorTipo = pedidosCj.reduce((acc, pedido) => {
        const key = `${pedido.test}-${pedido.flauta}`;
        if (!acc[key]) {
            acc[key] = [];
        }
        acc[key].push(pedido);
        return acc;
    }, {});

    return pedidosPorTipo;
}
</script>