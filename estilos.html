<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparación de Coincidencias con Filtros Dinámicos</title>
    <style>
        #tabla-coincidencias {
            width: 100%;
            font-family: Arial, sans-serif;
            font-size: 14px;
            text-align: left;
            border-collapse: collapse;
        }

        #tabla-coincidencias th, #tabla-coincidencias td {
            padding: 8px;
            border: 1px solid #ddd;
        }

        #tabla-coincidencias tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        #tabla-coincidencias th {
            background-color: #4CAF50;
            color: white;
        }

        .filtros {
            margin-bottom: 20px;
        }

        .filtros label {
            margin-right: 10px;
        }

        .filtros select {
            padding: 5px;
            margin-right: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .sin-datos {
            color: #999;
            font-style: italic;
        }
    </style>
</head>
<body>

    <h1>Comparación de Coincidencias con Filtros Dinámicos</h1>

    <!-- Controles de filtro -->
    <div class="filtros">
        <label for="filtro-gramaje">Filtrar por Gramaje:</label>
        <select id="filtro-gramaje">
            <option value="">Todos</option>
        </select>

        <label for="filtro-ancho">Filtrar por Ancho:</label>
        <select id="filtro-ancho">
            <option value="">Todos</option>
        </select>
    </div>

    <table id="tabla-coincidencias">
        <thead>
            <tr>
                <th>Gramaje</th>
                <th>Ancho</th>
                <th>Descripción Corrugador</th>
                <th>Descripción Comercial</th>
                <th>Cantidad</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="5" class="sin-datos">Cargando datos...</td></tr>
        </tbody>
    </table>

    <script>
        let todasLasCoincidencias = [];

        // Función para obtener datos de la API de corrugador
        async function apicorru() {
            try {
                const url = "https://megawebsistem.com/admin/api/apicorrugador2";
                const resultado = await fetch(url);
                return await resultado.json();
            } catch (e) {
                console.error("Error en apicorru:", e);
                return [];
            }
        }

        // Función para obtener datos de la API comercial
        async function apicomercial() {
            try {
                const url = "https://megawebsistem.com/admin/api/apicomercial";
                const resultado = await fetch(url);
                return await resultado.json();
            } catch (e) {
                console.error("Error en apicomercial:", e);
                return [];
            }
        }

        // Función para cargar los valores de filtro dinámicamente
        async function cargarFiltros() {
            const corru = await apicorru();

            // Extraer gramajes y anchos únicos
            const gramajesUnicos = [...new Set(corru.map(item => item.gramaje))];
            const anchosUnicos = [...new Set(corru.map(item => item.ancho))];

            // Llenar el select de gramaje
            const selectGramaje = document.getElementById("filtro-gramaje");
            gramajesUnicos.forEach(gramaje => {
                const option = document.createElement("option");
                option.value = gramaje;
                option.textContent = gramaje;
                selectGramaje.appendChild(option);
            });

            // Llenar el select de ancho
            const selectAncho = document.getElementById("filtro-ancho");
            anchosUnicos.forEach(ancho => {
                const option = document.createElement("option");
                option.value = ancho;
                option.textContent = ancho;
                selectAncho.appendChild(option);
            });
        }

        // Función para procesar y comparar los datos de ambas APIs
        async function desgloza() {
            const corru = await apicorru();
            const comercial = await apicomercial();

            todasLasCoincidencias = [];

            corru.forEach(corrugador => {
                const { gramaje, ancho, descripcion: descCorru = "Sin descripción" } = corrugador;

                // Busca registros en comercial donde el gramaje y el ancho coincidan
                const match = comercial.find(com => 
                    Number(com.gramaje) === Number(gramaje) && 
                    Number(com.ancho) === Number(ancho)
                );

                if (match) {
                    todasLasCoincidencias.push({
                        gramaje,
                        ancho,
                        descCorru,
                        descComercial: match.linea || match.producto || "Sin descripción",
                        cantidad: match.cantidad || "No especificada"
                    });
                }
            });

            mostrarTabla(todasLasCoincidencias);
        }

        // Función para mostrar las coincidencias en la tabla
        function mostrarTabla(coincidencias) {
            const tabla = document.getElementById("tabla-coincidencias");
            const tbody = tabla.querySelector("tbody");

            tbody.innerHTML = ""; // Limpiar contenido previo

            if (coincidencias.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="sin-datos">No se encontraron coincidencias</td></tr>`;
                return;
            }

            coincidencias.forEach(({ gramaje, ancho, descCorru, descComercial, cantidad }) => {
                const fila = `
                    <tr>
                        <td>${gramaje}</td>
                        <td>${ancho}</td>
                        <td>${descCorru}</td>
                        <td>${descComercial}</td>
                        <td>${cantidad}</td>
                    </tr>
                `;
                tbody.innerHTML += fila;
            });
        }

        // Función para aplicar los filtros
        function aplicarFiltros() {
            const filtroGramaje = document.getElementById("filtro-gramaje").value;
            const filtroAncho = document.getElementById("filtro-ancho").value;

            let resultadosFiltrados = todasLasCoincidencias;

            if (filtroGramaje) {
                resultadosFiltrados = resultadosFiltrados.filter(item => Number(item.gramaje) === Number(filtroGramaje));
            }

            if (filtroAncho) {
                resultadosFiltrados = resultadosFiltrados.filter(item => Number(item.ancho) === Number(filtroAncho));
            }

            mostrarTabla(resultadosFiltrados);
        }

        // Escucha de eventos para los filtros
        document.getElementById("filtro-gramaje").addEventListener("change", aplicarFiltros);
        document.getElementById("filtro-ancho").addEventListener("change", aplicarFiltros);

        // Ejecutar las funciones al cargar la página
        document.addEventListener("DOMContentLoaded", async () => {
            await cargarFiltros();
            await desgloza();
        });
    </script>

</body>
</html>
